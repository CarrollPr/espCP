<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Web Flasher</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(-45deg, #0f1419, #1a202c, #2d3748, #1e293b);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px) saturate(120%);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            padding: 24px;
            margin-bottom: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #fff 0%, #f0f9ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 40px rgba(255,255,255,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.8;
        }

        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .connection-panel, .flash-panel {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .panel-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ef4444;
            transition: background 0.3s ease;
        }

        .status-indicator.connected {
            background: #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        .btn {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            font-weight: 600;
        }

        .btn-primary:hover {
            box-shadow: 0 6px 25px rgba(16, 185, 129, 0.6);
            transform: translateY(-3px);
        }

        .file-upload {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload:hover {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.02);
        }

        .file-upload.drag-over {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .address-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .address-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            width: 120px;
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            height: 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 8px;
        }

        .terminal {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            height: 300px;
            overflow-y: auto;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .terminal-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .advanced-panel {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .advanced-panel.show {
            display: grid;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .form-group input, .form-group select {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .footer {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(10px) saturate(120%);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            margin-top: auto;
        }

        .mobile-warning {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            padding: 40px 30px;
            background: rgba(239, 68, 68, 0.15);
            backdrop-filter: blur(20px) saturate(120%);
            border: 1px solid rgba(239, 68, 68, 0.4);
            border-radius: 20px;
            margin: 0;
            max-width: 90vw;
            width: 400px;
            z-index: 1000;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .mobile-warning {
                display: block;
            }
            
            .desktop-content {
                display: none;
            }
        }

        /* Scrollbar styling */
        .terminal::-webkit-scrollbar {
            width: 8px;
        }

        .terminal::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .terminal::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        .log-entry {
            margin-bottom: 4px;
            opacity: 0.9;
        }

        .log-entry.error {
            color: #ff6b6b;
        }

        .log-entry.success {
            color: #51cf66;
        }

        .log-entry.info {
            color: #74c0fc;
        }
    </style>
</head>
<body>
    <!-- Mobile Warning -->
    <div class="mobile-warning">
        <h2><i data-lucide="alert-triangle"></i> –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</h2>
        <p>–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WebSerial API. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome –∏–ª–∏ Edge –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ.</p>
    </div>

    <!-- Desktop Content -->
    <div class="container desktop-content">
        <div class="glass-panel header">
            <h1><i data-lucide="cpu" style="display: inline-block; margin-right: 12px;"></i>ESP32 Web Flasher</h1>
            <p>–ü—Ä–æ—à–∏–≤–∫–∞ ESP32 –ø–ª–∞—Ç —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä —Å –ø–æ–º–æ—â—å—é Web Serial API</p>
        </div>

        <div class="main-content">
            <!-- Connection Panel -->
            <div class="glass-panel connection-panel">
                <h2 class="panel-title">
                    <span class="status-indicator" id="connectionStatus"></span>
                    <i data-lucide="wifi"></i>
                    –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                </h2>
                
                <button class="btn btn-primary" id="connectBtn">–í—ã–±—Ä–∞—Ç—å –ø–æ—Ä—Ç</button>
                
                <div class="form-group">
                    <label>–°–∫–æ—Ä–æ—Å—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (baud)</label>
                    <select id="baudRate">
                        <option value="115200">115200</option>
                        <option value="230400">230400</option>
                        <option value="460800">460800</option>
                        <option value="921600">921600</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="autoReset" checked> –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ –≤ bootloader
                    </label>
                </div>

                <button class="btn" id="manualReset" style="display: none;">–†—É—á–Ω–æ–π —Å–±—Ä–æ—Å</button>
                
                <button class="btn" id="advancedToggle">–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                
                <div class="advanced-panel" id="advancedPanel">
                    <div class="form-group">
                        <label>–†–∞–∑–º–µ—Ä chunk (–±–∞–π—Ç)</label>
                        <input type="number" id="chunkSize" value="4096" min="256" max="65536">
                    </div>
                    <div class="form-group">
                        <label>–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏</label>
                        <input type="number" id="retryCount" value="3" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label>Timeout –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–º—Å)</label>
                        <input type="number" id="connectTimeout" value="5000" min="1000" max="30000">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="eraseChip"> –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —á–∏–ø–∞
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="verifyAfterWrite" checked> –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏
                        </label>
                    </div>
                </div>
            </div>

            <!-- Flash Panel -->
            <div class="glass-panel flash-panel">
                <h2 class="panel-title"><i data-lucide="download"></i>–ü—Ä–æ—à–∏–≤–∫–∞</h2>
                
                <div class="file-upload" id="fileUpload">
                    <div><i data-lucide="folder-open" style="margin-right: 8px;"></i>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ .bin —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</div>
                    <input type="file" id="fileInput" accept=".bin" multiple style="display: none;">
                </div>

                <div id="fileList"></div>

                <div style="font-size: 0.9rem; opacity: 0.7; margin: 10px 0;">
                    üí° –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∞–¥—Ä–µ—Å–∞: 0x1000 (bootloader), 0x8000 (partition), 0x10000 (app)
                </div>

                <button class="btn btn-primary" id="flashBtn" disabled>–ü—Ä–æ—à–∏—Ç—å</button>

                <div class="progress-container" id="progressContainer" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text">
                        <span id="progressText">0%</span>
                        <span id="speedText">0 KB/s</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Terminal -->
        <div class="glass-panel">
            <div class="terminal-controls">
                <span style="font-weight: 600;"><i data-lucide="terminal" style="margin-right: 8px;"></i>–¢–µ—Ä–º–∏–Ω–∞–ª</span>
                <div style="margin-left: auto; display: flex; gap: 10px;">
                    <button class="btn" onclick="clearTerminal()"><i data-lucide="trash-2" style="margin-right: 4px;"></i>–û—á–∏—Å—Ç–∏—Ç—å</button>
                    <button class="btn" onclick="copyLog()"><i data-lucide="copy" style="margin-right: 4px;"></i>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥</button>
                    <button class="btn" onclick="downloadLog()"><i data-lucide="download" style="margin-right: 4px;"></i>–°–∫–∞—á–∞—Ç—å –ª–æ–≥</button>
                </div>
            </div>
            <div class="terminal" id="terminal"></div>
        </div>

        <div class="footer">
            <p>by Aik Carroll</p>
        </div>
    </div>

<script src="https://unpkg.com/esptool-js@0.5.7/lib/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/esptool-js@0.5.7/lib/index.js"></script>

    
    <script>
        /*
        README - ESP32 Web Flasher
        
        –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–ª–∞—Ç—ã:
        1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º: –ø—Ä–æ—Å—Ç–æ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –ø–ª–∞—Ç—É –∏ –Ω–∞–∂–º–∏—Ç–µ "–í—ã–±—Ä–∞—Ç—å –ø–æ—Ä—Ç"
        2. –†—É—á–Ω–æ–π —Ä–µ–∂–∏–º: —É–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ BOOT (GPIO0), –Ω–∞–∂–º–∏—Ç–µ RESET (EN), –æ—Ç–ø—É—Å—Ç–∏—Ç–µ RESET, –æ—Ç–ø—É—Å—Ç–∏—Ç–µ BOOT
        
        –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∞–¥—Ä–µ—Å–∞:
        - 0x1000: Bootloader
        - 0x8000: Partition table  
        - 0x10000: Application
        
        –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ baud rates: 115200, 230400, 460800, 921600
        
        QA –ß–µ–∫–ª–∏—Å—Ç:
        ‚úì –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É esptool-js (–∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞)
        ‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WebSerial (Chrome/Edge –Ω–∞ –ü–ö)
        ‚úì –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ –≤ bootloader
        ‚úì –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø—Ä–æ—à–∏–≤–∫–∞ blink.bin
        ‚úì –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º (–¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ)
        */

        // Global variables
        let port = null;
        let loader = null;
        let transport = null;
        let isConnected = false;
        let terminalLog = [];

        // Check if we're in a secure context and browser supports WebSerial
        function checkWebSerialSupport() {
            if (!window.isSecureContext) {
                logToTerminal('‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è HTTPS –∏–ª–∏ localhost –¥–ª—è —Ä–∞–±–æ—Ç—ã Web Serial API', 'error');
                return false;
            }
            
            if (!navigator.serial) {
                logToTerminal('‚ùå Web Serial API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ', 'error');
                return false;
            }
            
            return true;
        }

        // Check esptool-js library loading
        function checkESPToolLibrary() {
            setTimeout(() => {
                const espToolKeys = Object.keys(window.esptooljs || window.ESPLoader || window.esptool || {});
                logToTerminal(`üîç –î–æ—Å—Ç—É–ø–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç—ã –±–∏–±–ª–∏–æ—Ç–µ–∫–∏: ${espToolKeys.length > 0 ? espToolKeys.join(', ') : '–Ω–µ –Ω–∞–π–¥–µ–Ω—ã'}`, 'info');
                
                if (typeof ESPLoader === 'undefined') {
                    logToTerminal('‚ùå ESPLoader –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–µ', 'error');
                    logToTerminal('üîß –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É', 'info');
                } else {
                    logToTerminal('‚úÖ ESPLoader —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
                }
            }, 1000);
        }

        // Terminal logging
        function logToTerminal(message, type = 'info') {
            const terminal = document.getElementById('terminal');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            terminal.appendChild(logEntry);
            terminal.scrollTop = terminal.scrollHeight;
            
            terminalLog.push(`[${timestamp}] ${message}`);
        }

        function clearTerminal() {
            document.getElementById('terminal').innerHTML = '';
            terminalLog = [];
        }

        function copyLog() {
            navigator.clipboard.writeText(terminalLog.join('\n'));
            logToTerminal('üìã –õ–æ–≥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
        }

        function downloadLog() {
            const blob = new Blob([terminalLog.join('\n')], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `esp-flasher-log-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // WebSerial Transport Adapter
        class WebSerialTransportAdapter {
            constructor(port) {
                this.port = port;
                this.reader = null;
                this.writer = null;
                this.readBuffer = new Uint8Array(0);
            }

            async connect(baudRate = 115200) {
                try {
                    await this.port.open({ baudRate });
                    this.reader = this.port.readable.getReader();
                    this.writer = this.port.writable.getWriter();
                    logToTerminal(`üîå –ü–æ—Ä—Ç –æ—Ç–∫—Ä—ã—Ç –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ ${baudRate} baud`, 'success');
                    return true;
                } catch (error) {
                    logToTerminal(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
                    return false;
                }
            }

            async disconnect() {
                try {
                    if (this.reader) {
                        await this.reader.cancel();
                        await this.reader.releaseLock();
                    }
                    if (this.writer) {
                        await this.writer.releaseLock();
                    }
                    if (this.port) {
                        await this.port.close();
                    }
                } catch (error) {
                    logToTerminal(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏: ${error.message}`, 'error');
                }
            }

            async write(data) {
                if (this.writer) {
                    await this.writer.write(data);
                }
            }

            async read(timeout = 3000) {
                if (!this.reader) return new Uint8Array(0);
                
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Read timeout')), timeout)
                );
                
                try {
                    const result = await Promise.race([this.reader.read(), timeoutPromise]);
                    if (result.done) {
                        return new Uint8Array(0);
                    }
                    return result.value;
                } catch (error) {
                    if (error.message === 'Read timeout') {
                        return new Uint8Array(0);
                    }
                    throw error;
                }
            }

            async setSignals(signals) {
                if (this.port.setSignals) {
                    await this.port.setSignals(signals);
                }
            }
        }

        // Auto bootloader entry
        async function autoEnterBootloader(port) {
            try {
                logToTerminal('üîÑ –ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—Ö–æ–¥–∞ –≤ bootloader...', 'info');
                
                // Reset sequence based on esptool timing
                await port.setSignals({ dataTerminalReady: false, requestToSend: true });
                await new Promise(resolve => setTimeout(resolve, 100));
                
                await port.setSignals({ dataTerminalReady: true, requestToSend: false });
                await new Promise(resolve => setTimeout(resolve, 50));
                
                await port.setSignals({ dataTerminalReady: false, requestToSend: false });
                await new Promise(resolve => setTimeout(resolve, 50));
                
                logToTerminal('‚úÖ –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–≤—Ç–æ—Å–±—Ä–æ—Å–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞', 'success');
                return true;
            } catch (error) {
                logToTerminal(`‚ùå –ê–≤—Ç–æ-–≤—Ö–æ–¥ –≤ bootloader –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª: ${error.message}`, 'error');
                logToTerminal('üîß –£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ BOOT (GPIO0), –Ω–∞–∂–º–∏—Ç–µ RESET (EN), –æ—Ç–ø—É—Å—Ç–∏—Ç–µ RESET, –æ—Ç–ø—É—Å—Ç–∏—Ç–µ BOOT', 'info');
                return false;
            }
        }

        // Connect to ESP32
        async function connectToESP32() {
            if (!checkWebSerialSupport()) return;
            
            try {
                logToTerminal('üîç –ó–∞–ø—Ä–æ—Å –ø–æ—Ä—Ç–∞...', 'info');
                
                const filters = [
                    { usbVendorId: 0x10C4 }, // CP210x
                    { usbVendorId: 0x1A86 }, // CH340
                    { usbVendorId: 0x0403 }, // FTDI
                    { usbVendorId: 0x067B }, // Prolific
                ];
                
                port = await navigator.serial.requestPort({ filters });
                logToTerminal('üì± –ü–æ—Ä—Ç –≤—ã–±—Ä–∞–Ω', 'info');
                
                const baudRate = parseInt(document.getElementById('baudRate').value);
                transport = new WebSerialTransportAdapter(port);
                
                if (!(await transport.connect(baudRate))) {
                    return;
                }
                
                // Auto-reset if enabled
                const autoReset = document.getElementById('autoReset').checked;
                if (autoReset) {
                    await autoEnterBootloader(port);
                }
                
                // Create ESPLoader instance
                const terminal = {
                    clean() {},
                    writeLine(data) { 
                        logToTerminal(data, 'info'); 
                    },
                    write(data) { 
                        logToTerminal(data, 'info'); 
                    }
                };
                
                loader = new ESPLoader({
                    transport: transport,
                    baudrate: baudRate,
                    terminal: terminal
                });
                
                logToTerminal('üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ESP32...', 'info');
                await loader.connect();
                
                logToTerminal('üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...', 'info');
                await loader.sync();
                
                const chipType = await loader.chipName();
                logToTerminal(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ ${chipType}`, 'success');
                
                isConnected = true;
                updateUI();
                
            } catch (error) {
                logToTerminal(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
                
                if (error.message.includes('timeout') || error.message.includes('packet header')) {
                    logToTerminal('üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:', 'info');
                    logToTerminal('   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–ª–∞—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ bootloader', 'info');
                    logToTerminal('   ‚Ä¢ –°–Ω–∏–∑–∏—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å baud rate', 'info');
                    logToTerminal('   ‚Ä¢ –£–º–µ–Ω—å—à–∏—Ç—å —Ä–∞–∑–º–µ—Ä chunk –¥–æ 4096', 'info');
                    logToTerminal('   ‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä—É—á–Ω–æ–π –≤—Ö–æ–¥ –≤ bootloader', 'info');
                }
                
                isConnected = false;
                updateUI();
            }
        }

        // Flash firmware
        async function flashFirmware() {
            if (!loader || !isConnected) {
                logToTerminal('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É', 'error');
                return;
            }
            
            const fileList = document.getElementById('fileList');
            const fileItems = fileList.querySelectorAll('.file-item');
            
            if (fileItems.length === 0) {
                logToTerminal('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –ø—Ä–æ—à–∏–≤–∫–∏', 'error');
                return;
            }
            
            try {
                const progressContainer = document.getElementById('progressContainer');
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                const speedText = document.getElementById('speedText');
                
                progressContainer.style.display = 'block';
                
                // Prepare files array
                const files = [];
                for (const item of fileItems) {
                    const address = parseInt(item.dataset.address, 16);
                    const fileData = item.dataset.fileData;
                    
                    files.push({
                        address: address,
                        data: fileData
                    });
                }
                
                // Erase chip if requested
                if (document.getElementById('eraseChip').checked) {
                    logToTerminal('üóëÔ∏è –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —á–∏–ø–∞...', 'info');
                    await loader.eraseFlash();
                }
                
                // Flash options
                const flashOptions = {
                    reportProgress: (fileIndex, written, total) => {
                        const progress = (written / total) * 100;
                        progressFill.style.width = `${progress}%`;
                        progressText.textContent = `${Math.round(progress)}%`;
                        
                        // Calculate speed (simplified)
                        const speed = (written / 1024).toFixed(1);
                        speedText.textContent = `${speed} KB/s`;
                    },
                    eraseAll: document.getElementById('eraseChip').checked
                };
                
                logToTerminal('üìù –ó–∞–ø–∏—Å—å –ø—Ä–æ—à–∏–≤–∫–∏...', 'info');
                await loader.writeFlash(files, flashOptions);
                
                // Verify if enabled
                if (document.getElementById('verifyAfterWrite').checked) {
                    logToTerminal('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—à–∏–≤–∫–∏...', 'info');
                    // Note: verify implementation depends on esptool-js version
                }
                
                logToTerminal('üöÄ –ì–æ—Ç–æ–≤–æ ‚Äî —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∑–∞–ø—É—â–µ–Ω–æ', 'success');
                
                // Reset device
                await loader.hardReset();
                
                progressFill.style.width = '100%';
                progressText.textContent = '100%';
                
            } catch (error) {
                logToTerminal(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ—à–∏–≤–∫–∏: ${error.message}`, 'error');
                logToTerminal(`üîß –°—Ç–µ–∫ –æ—à–∏–±–∫–∏: ${error.stack}`, 'error');
            }
        }

        // File handling
        function handleFiles(files) {
            const fileList = document.getElementById('fileList');
            
            for (const file of files) {
                if (!file.name.endsWith('.bin')) {
                    logToTerminal(`‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω —Ñ–∞–π–ª ${file.name} (–Ω–µ .bin)`, 'error');
                    continue;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const fileItem = createFileItem(file, e.target.result);
                    fileList.appendChild(fileItem);
                    updateFlashButton();
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function createFileItem(file, arrayBuffer) {
            const item = document.createElement('div');
            item.className = 'glass-panel';
            item.style.padding = '16px';
            item.style.marginBottom = '10px';
            
            const sizeKB = (arrayBuffer.byteLength / 1024).toFixed(1);
            
            // Convert to base64 for esptool-js
            const uint8Array = new Uint8Array(arrayBuffer);
            let binary = '';
            for (let i = 0; i < uint8Array.length; i++) {
                binary += String.fromCharCode(uint8Array[i]);
            }
            const base64 = btoa(binary);
            
            item.dataset.fileData = base64;
            
            item.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span><i data-lucide="file" style="margin-right: 8px;"></i><strong>${file.name}</strong> (${sizeKB} KB)</span>
                    <button class="btn" onclick="removeFile(this)" style="padding: 6px 12px;"><i data-lucide="x"></i></button>
                </div>
                <div class="address-group">
                    <span><i data-lucide="map-pin" style="margin-right: 4px;"></i>–ê–¥—Ä–µ—Å:</span>
                    <input type="text" class="address-input" value="0x10000" onchange="updateAddress(this)">
                </div>
            `;
            
            // Re-initialize icons for this new content
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            item.dataset.address = '0x10000';
            item.className = 'file-item glass-panel';
            
            return item;
        }

        function removeFile(button) {
            button.closest('.file-item').remove();
            updateFlashButton();
        }

        function updateAddress(input) {
            const item = input.closest('.file-item');
            item.dataset.address = input.value;
        }

        function setAddress(address) {
            const activeAddressInput = document.querySelector('.file-item:last-child .address-input');
            if (activeAddressInput) {
                activeAddressInput.value = address;
                updateAddress(activeAddressInput);
            }
        }

        function updateFlashButton() {
            const flashBtn = document.getElementById('flashBtn');
            const fileItems = document.querySelectorAll('.file-item');
            flashBtn.disabled = !isConnected || fileItems.length === 0;
        }

        function updateUI() {
            const connectionStatus = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');
            const manualReset = document.getElementById('manualReset');
            
            if (isConnected) {
                connectionStatus.classList.add('connected');
                connectBtn.textContent = '–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è';
                connectBtn.onclick = disconnect;
                manualReset.style.display = document.getElementById('autoReset').checked ? 'none' : 'block';
            } else {
                connectionStatus.classList.remove('connected');
                connectBtn.textContent = '–í—ã–±—Ä–∞—Ç—å –ø–æ—Ä—Ç';
                connectBtn.onclick = connectToESP32;
                manualReset.style.display = 'none';
            }
            
            updateFlashButton();
        }

        async function disconnect() {
            if (transport) {
                await transport.disconnect();
            }
            isConnected = false;
            loader = null;
            transport = null;
            port = null;
            updateUI();
            logToTerminal('üîå –û—Ç–∫–ª—é—á–µ–Ω–æ', 'info');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            checkESPToolLibrary();
            
            if (!checkWebSerialSupport()) {
                document.querySelector('.desktop-content').style.display = 'none';
                document.querySelector('.mobile-warning').style.display = 'block';
                return;
            }
            
            // File upload
            const fileUpload = document.getElementById('fileUpload');
            const fileInput = document.getElementById('fileInput');
            
            fileUpload.onclick = () => fileInput.click();
            fileInput.onchange = (e) => handleFiles(e.target.files);
            
            // Drag and drop
            fileUpload.ondragover = (e) => {
                e.preventDefault();
                fileUpload.classList.add('drag-over');
            };
            
            fileUpload.ondragleave = () => {
                fileUpload.classList.remove('drag-over');
            };
            
            fileUpload.ondrop = (e) => {
                e.preventDefault();
                fileUpload.classList.remove('drag-over');
                handleFiles(e.dataTransfer.files);
            };
            
            // Advanced toggle
            document.getElementById('advancedToggle').onclick = () => {
                const panel = document.getElementById('advancedPanel');
                panel.classList.toggle('show');
            };
            
            // Auto reset toggle
            document.getElementById('autoReset').onchange = (e) => {
                const manualReset = document.getElementById('manualReset');
                manualReset.style.display = e.target.checked ? 'none' : 'block';
            };
            
            // Manual reset
            document.getElementById('manualReset').onclick = async () => {
                if (port && port.setSignals) {
                    await autoEnterBootloader(port);
                } else {
                    logToTerminal('üîß –£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ BOOT (GPIO0), –Ω–∞–∂–º–∏—Ç–µ RESET (EN), –æ—Ç–ø—É—Å—Ç–∏—Ç–µ RESET, –æ—Ç–ø—É—Å—Ç–∏—Ç–µ BOOT', 'info');
                }
            };
            
            // Flash button
            document.getElementById('flashBtn').onclick = flashFirmware;
            
            // Connect button
            document.getElementById('connectBtn').onclick = connectToESP32;
            
            updateUI();
        });
    </script>
</body>
</html>
